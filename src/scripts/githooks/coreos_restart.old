#!/usr/bin/bash
#=================================================================================
# CoreOS Restart - Generated by PandaHook https://github.com/pandastrike/panda-hook
#=================================================================================
# This Bash script controls the actions of a hook-server. While triggered by a git
# command, this server can taking any additional action possible on a Linux machine.

# Algorithm:
# (1) Perform a clone of the "bare" repo we just pushed to, creating a regular repo.
# (2) Use the *.service files in the regular repo to re-deploy CoreOS services.

echo ""
echo "==================================="
echo "Push Detected. Activating Githook."
echo "==================================="

# Cloning the (freshly updated) bare repo creates a regular one with files we can use.
# Note that our starting directory is the repo's root, not the path of the githook script.
echo ""
echo "-----------"
echo "Cloning Bare Repo"
echo "-----------"

# First, determine the branch being pushed and checkout that one.  That information is available
# from the standard input.
read old_hash new_hash branch_name
branch_name=${branch_name:11}

# Next, wipe away any old versions of the regular repo and clone from the updated bare repo.
cd ..
rm -rf {{{repo_name}}}
/usr/bin/git clone -b $branch_name {{{repo_name}}}.git  {{{repo_name}}}
cd {{{repo_name}}}


echo ""
echo "-----------"
echo "Stopping Service(s)"
echo "-----------"

# Determine which services should be restarted by searching the regular repo's "launch"
# directory.  Every subdirectory there represents something that needs a restart.
cd {{{launch_path}}}
services=(*/)
for service in ${services[@]};
do
  /usr/bin/ssh -A -o "StrictHostKeyChecking no" -o "UserKnownHostsFile=/dev/null" -p {{{cluster_port}}} {{{cluster_address}}} "/usr/bin/fleetctl destroy ${service::-1}.service"
done

# It sometimes takes the CoreOS cluster a moment to register your command.  If
# we wait a few seconds, the service will properly begin the termination sequence
# before registering the following "start" command.
sleep 5

echo ""
echo "-----------"
echo "Restarting Service(s)"
echo "-----------"

# Finally, bring the service(s) back online.
for service in ${services[@]};
do
  # Delete the current launch directory if it stands in our way.
  /usr/bin/ssh -A -o "StrictHostKeyChecking no" -o "UserKnownHostsFile=/dev/null" -p {{{cluster_port}}} {{{cluster_address}}} "sudo rm -rf launch/$service"
  scp -o "StrictHostKeyChecking no" -o "UserKnownHostsFile=/dev/null" -P {{{cluster_port}}} -r $service {{{cluster_address}}}:/home/core/launch/
  /usr/bin/ssh -A -o "StrictHostKeyChecking no" -o "UserKnownHostsFile=/dev/null" -p {{{cluster_port}}} {{{cluster_address}}} "/usr/bin/fleetctl start launch/$service${service::-1}.service"
done
